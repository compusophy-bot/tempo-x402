name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"

jobs:
  # Test gate: must pass before building release artifacts
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2
      - name: Run tests
        run: cargo test --workspace
      - name: Run clippy
        run: cargo clippy --workspace -- -D warnings
      - name: Check formatting
        run: cargo fmt --all -- --check

  # Docs validation: version consistency check
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate version consistency
        run: |
          # Extract tag version (strip 'v' prefix)
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"

          # Get version from core crate (source of truth)
          CORE_VERSION=$(grep -m1 '^version = ' crates/tempo-x402/Cargo.toml | sed 's/version = "\(.*\)"/\1/')

          # Check tag matches core version
          if [ "$TAG_VERSION" != "$CORE_VERSION" ]; then
            echo "❌ Tag version ($TAG_VERSION) != crates/tempo-x402 version ($CORE_VERSION)"
            echo "Fix: Update crate versions to $TAG_VERSION before tagging"
            exit 1
          fi
          echo "✓ Tag matches core version: $CORE_VERSION"

          # Check all crates match
          for crate in tempo-x402-server tempo-x402-facilitator tempo-x402-gateway; do
            CRATE_VERSION=$(grep -m1 '^version = ' "crates/$crate/Cargo.toml" | sed 's/version = "\(.*\)"/\1/')
            if [ "$CRATE_VERSION" != "$CORE_VERSION" ]; then
              echo "❌ crates/$crate version ($CRATE_VERSION) != core ($CORE_VERSION)"
              exit 1
            fi
            echo "✓ crates/$crate version matches"
          done

          # Check llms.txt
          LLMS_VERSION=$(grep -A1 "^## Version" llms.txt | tail -1 | tr -d '[:space:]')
          if [ "$LLMS_VERSION" != "$CORE_VERSION" ]; then
            echo "❌ llms.txt version ($LLMS_VERSION) != core ($CORE_VERSION)"
            echo "Fix: Run ./scripts/bump-version.sh $CORE_VERSION"
            exit 1
          fi
          echo "✓ llms.txt version matches"

          echo ""
          echo "All versions consistent: $CORE_VERSION"

  build:
    needs: [test, docs]
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package binaries
        shell: bash
        run: |
          tag="${GITHUB_REF#refs/tags/}"
          mkdir -p dist
          for bin in x402-server x402-facilitator x402-client x402-approve x402-gateway; do
            src="target/${{ matrix.target }}/release/${bin}"
            if [ -f "$src" ]; then
              cp "$src" "dist/${bin}-${tag}-${{ matrix.target }}"
            fi
          done

      - uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.target }}
          path: dist/

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
